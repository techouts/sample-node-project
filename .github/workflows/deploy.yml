name: Deploy Application on VM

on:
  push:
    branches:
      - master   # Trigger workflow on push to master branch

jobs:
  deploy:
    runs-on: self-hosted   # Use your self-hosted runner (the VM itself)

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy Application on VM
        run: |
          # Create app directory if not exists
          mkdir -p /home/tech/app
          cd /home/tech/app

          # Copy only repository files to app directory, excluding .git and workflow files
          rsync -av --exclude='.git' --exclude='.github' $GITHUB_WORKSPACE/ .

          # Optional: Install Python dependencies if it is a Python app
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi

          # Stop previous instance of app if running
          pkill -f "python3 app.py" || true

          # Start the application in the background
          nohup python3 app.py > app.log 2>&1 &
